<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>LocalShare â€” {{ folder_name }}</title>
        <link rel="stylesheet" href="/static/style.css">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/static/app_icon.png" type="image/png">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
        <style>
            /* Basic styles for toast and progress - adjust as needed */
            .toast {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0,0,0,0.7);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                display: none; /* Hidden by default */
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            }
            .toast.error {
                background-color: rgba(200,0,0,0.8);
            }
            .progress-wrap {
                display: flex; /* Changed back to flex for alignment */
                align-items: center;
                margin-top: 10px;
            }
            .progress {
                flex-grow: 1;
                height: 10px;
                background-color: #eee;
                border-radius: 5px;
                overflow: hidden;
            }
            .progress i {
                display: block;
                height: 100%;
                background-color: #4a69bd; /* Match button color */
                transition: width 0.1s linear;
                border-radius: 5px;
            }
            .file-item.small { /* Simple style for selected list */
                padding: 5px 0;
                font-size: 0.9em;
                display: flex;
                align-items: center;
            }
            .file-item.small .file-thumb {
                 width: 25px; height: 25px; line-height: 25px; font-size: 0.8em; margin-right: 8px; flex-shrink: 0;
            }
            .file-item.small .file-meta { flex-grow: 1; }
            .file-item.small .file-name { font-weight: bold;}
            .file-item.small .file-size { font-size: 0.8em; color: #666;}
             /* Add styles from previous answer if needed for logo, etc. */
            .logo-img {
                width: 40px;
                height: 40px;
                margin-right: 15px;
                vertical-align: middle;
                border-radius: 8px;
            }
            .app-bar {
                display: flex;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
            }
            .app-bar .title { margin: 0; }
            .app-bar .subtitle { font-size: 0.9em; color: #555; }
        </style>
    </head>
    <body>
        <main class="container">
            <header class="app-bar">
                <img src="/static/app_icon.png" alt="LocalShare Logo" class="logo-img">
                <div>
                    <h1 class="title">{{ folder_name }}</h1>
                    <div class="subtitle">Local file sharing</div>
                </div>
            </header>

            <section class="card" aria-labelledby="uploadHeading">
                <h2 id="uploadHeading">Upload files</h2>
                <label class="upload-zone" id="dropZone" for="fileInput" tabindex="0">
                    <strong>Tap to choose or drop files</strong>
                    <p>Files will be added to the shared folder.</p>
                    <div class="actions">
                        <button class="btn btn-primary" id="chooseBtn" type="button">Select files</button>
                    </div>
                    <input id="fileInput" name="files" type="file" multiple style="display:none">
                </label>

                <div class="selected-files-preview" id="selectedFilesPreview" style="display:none;">
                    <h4>Selected:</h4>
                    <div class="file-list" id="selectedList"></div>
                    <div class="progress-wrap" id="progressWrap" style="display:none">
                        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                            <i id="progressBar" style="width:0%"></i>
                        </div>
                        <span id="progressText" style="font-size: 0.9em; margin-left: 10px;"></span>
                    </div>
                    <div class="actions" style="margin-top: 15px;">
                         <button class="btn btn-ghost" id="clearBtn" type="button">Clear</button>
                     </div>
                </div>
            </section>

            <section class="card" aria-labelledby="filesHeading">
                <h2 id="filesHeading">Shared files</h2>
                <div class="files-grid">
                    {% if files|length == 0 %}
                        <div class="empty">No files yet. Upload one to get started.</div>
                    {% endif %}
                    {% for file in files %}
                        <article class="file-item" aria-label="{{ file.name }}">
                            <div class="file-thumb">{{ file.name[0]|upper }}</div>
                            <div class="file-meta">
                                <div class="file-name">{{ file.name }}</div>
                            </div>
                            <div class="file-actions">
                                <a class="download" href="/download/{{ file.url }}" download="{{ file.name }}">Download</a>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            </section>
        </main>

        <div class="toast" id="toast" role="status" aria-live="polite"></div>

        <script>
            (function(){
                // --- Get DOM Elements ---
                const dropZone = document.getElementById('dropZone');
                const input = document.getElementById('fileInput');
                const chooseBtn = document.getElementById('chooseBtn');
                const selectedFilesPreview = document.getElementById('selectedFilesPreview'); // Renamed div
                const selectedList = document.getElementById('selectedList');
                const progressWrap = document.getElementById('progressWrap');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const clearBtn = document.getElementById('clearBtn');
                const toast = document.getElementById('toast');

                // --- Utility Functions ---
                function showToast(msg, isError = false){ /* ... Keep showToast as before ... */
                    console.log(`Toast: ${msg} (Error: ${isError})`);
                    toast.textContent = msg;
                    toast.className = isError ? 'toast error' : 'toast';
                    toast.style.display='block';
                    requestAnimationFrame(() => {
                        toast.style.opacity = 1;
                    });
                    setTimeout(() => {
                         toast.style.opacity = 0;
                         setTimeout(() => toast.style.display = 'none', 300);
                    }, 3000);
                }
                function formatBytes(bytes, decimals = 2) { /* ... Keep formatBytes as before ... */
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const dm = decimals < 0 ? 0 : decimals;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                }

                // --- Core Logic Functions ---
                function handleFiles(fileList){
                    if(!fileList || fileList.length === 0) {
                        console.log("handleFiles: No files selected/dropped.");
                        return;
                    }

                    const files = Array.from(fileList);
                    console.log(`handleFiles: Processing ${files.length} files:`, files.map(f => f.name));

                    // --- Display selected files BEFORE starting upload ---
                    selectedList.innerHTML = ''; // Clear previous list display
                    files.forEach(f => {
                        const el = document.createElement('div');
                        el.className = 'file-item small';
                        el.innerHTML = `<div class="file-thumb">${f.name[0].toUpperCase()}</div><div class="file-meta"><div class="file-name">${f.name}</div><div class="file-size">${formatBytes(f.size)}</div></div>`;
                        selectedList.appendChild(el);
                    });
                    progressWrap.style.display = 'none'; // Hide progress bar initially
                    selectedFilesPreview.style.display = 'block'; // Show the preview area

                    // --- Start upload immediately ---
                    // Use a minimal timeout to allow the browser to render the list before upload starts
                    setTimeout(() => {
                        uploadFiles(files);
                    }, 50); // Small delay (50ms)

                    // Clear the input value AFTER initiating display/upload process
                    input.value = '';
                }

                function clearSelection() {
                    console.log("clearSelection: Clearing input and display.");
                    input.value = ''; // Reset the file input's value
                    selectedList.innerHTML = '';
                    selectedFilesPreview.style.display = 'none'; // Hide the preview area
                    progressWrap.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressText.textContent = '';
                }

                function uploadFiles(filesToUpload){
                    if (!filesToUpload || filesToUpload.length === 0) {
                        console.error("uploadFiles called with no files.");
                        showToast('No files to upload.', true);
                        clearSelection(); // Clear display if called erroneously
                        return;
                    }
                    console.log(`Starting upload for ${filesToUpload.length} files.`);

                    progressWrap.style.display = 'flex'; // Show progress bar
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                    chooseBtn.disabled = true; // Disable select button
                    clearBtn.disabled = true;  // Disable clear button

                    const xhr = new XMLHttpRequest();
                    const fd = new FormData();
                    filesToUpload.forEach(f => fd.append('files', f));

                    xhr.open('POST', '/upload', true);

                    xhr.upload.onprogress = function(e){ /* ... Keep progress handler ... */
                         if(e.lengthComputable){
                            const pct = Math.round((e.loaded / e.total) * 100);
                            progressBar.style.width = pct + '%';
                            progressText.textContent = pct + '%';
                        }
                    };

                    xhr.onload = function(){
                        console.log(`Upload finished with status: ${xhr.status}`);
                        chooseBtn.disabled = false; // Re-enable buttons
                        clearBtn.disabled = false;
                        if(xhr.status >= 200 && xhr.status < 300){
                            progressBar.style.width = '100%';
                            progressText.textContent = '100%';
                            showToast('Upload complete!');
                            // No need to clearSelection() as input was already cleared
                            setTimeout(() => {
                                 // Optionally hide progress/selection area before reload
                                 // selectedFilesPreview.style.display = 'none';
                                 location.reload();
                             }, 900);
                        } else {
                            // ... (Keep existing error handling) ...
                             let errorMsg = 'Upload failed';
                            try {
                                const response = JSON.parse(xhr.responseText);
                                errorMsg = `Upload failed: ${response.detail || response.error || 'Server error'}`;
                            } catch (parseError) {
                                errorMsg = `Upload failed: Server status ${xhr.status}`;
                            }
                            console.error("Upload failed:", errorMsg, xhr.responseText);
                            showToast(errorMsg, true);
                            progressWrap.style.display = 'none'; // Hide progress on error
                        }
                    };

                    xhr.onerror = function(){ /* ... Keep error handler ... */
                        console.error("Upload network error.");
                        showToast('Network error during upload.', true);
                        progressWrap.style.display = 'none';
                        chooseBtn.disabled = false;
                        clearBtn.disabled = false;
                    };

                    xhr.send(fd);
                }

                // --- Event Listeners Setup ---
                dropZone.addEventListener('click', (e) => {
                     if (e.target.tagName !== 'BUTTON') { input.click(); }
                });
                chooseBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); input.click();
                });
                dropZone.addEventListener('keydown', (e) => { /* ... Keep this ... */ });
                dropZone.addEventListener('dragover', (e) => { /* ... Keep this ... */ });
                dropZone.addEventListener('dragleave', () => { /* ... Keep this ... */ });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault(); dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files) { handleFiles(e.dataTransfer.files); }
                });
                input.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        handleFiles(e.target.files);
                    } else {
                         console.log("Input change event - no files selected (cancel).");
                         // Do nothing or clear display if desired:
                         // clearSelection();
                    }
                });

                // Clear button listener
                clearBtn.addEventListener('click', clearSelection);

                console.log("LocalShare script initialized (Immediate Upload Mode).");

            })();
        </script>
    </body>
</html>